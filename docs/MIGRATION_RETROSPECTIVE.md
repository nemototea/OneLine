# KMP/CMP 移行の振り返り

**プロジェクト:** OneLine（日記アプリ）
**期間:** Phase 1 ～ Phase 8-3
**日付:** 2025-11-11

## エグゼクティブサマリー

OneLine アプリを Android 専用アプリから Kotlin Multiplatform (KMP) / Compose Multiplatform (CMP) アプリへ移行しました。この移行により、Android と iOS の両プラットフォームで動作する日記アプリが完成し、コードの再利用性と保守性が大幅に向上しました。

**主な成果:**
- ✅ Android/iOS 両プラットフォームで動作
- ✅ 共通コードの割合: 約 85%
- ✅ 全テスト成功（34テストケース）
- ✅ ビルド成功（Android: 7秒、iOS: 1秒）

---

## 移行のタイムライン

### Phase 1-4: 基盤構築
- プロジェクト構造の再編成
- 依存関係の整理と共通化
- ビルドスクリプトの最適化
- UI の共通化（Compose Multiplatform）

### Phase 5: 依存性注入の移行
- Hilt から Koin への移行
- プラットフォーム固有モジュールの分離

### Phase 6: プラットフォーム固有機能の抽象化
- 通知システムの expect/actual 実装
- Android/iOS それぞれの actual 実装

### Phase 7: iOS アプリモジュールの作成
- iOS アプリモジュールの構築
- iOS エントリーポイントの実装
- iOS ビルド設定の最適化

### Phase 8: テストとドキュメント
- 共通コードのテスト（34テストケース）
- Android/iOS での統合テスト
- ドキュメントの整備

---

## 移行にかかった時間

| フェーズ | 作業内容 | 推定時間 |
|---------|---------|---------|
| Phase 1-4 | 基盤構築 | - |
| Phase 5 | Hilt→Koin 移行 | - |
| Phase 6-1 | 通知抽象化 | - |
| Phase 6-2 | Android 通知 | - |
| Phase 6-3 | iOS 通知 | - |
| Phase 7-1 | iOS アプリ | - |
| Phase 7-2 | iOS エントリー | - |
| Phase 7-3 | iOS ビルド設定 | - |
| Phase 8-1 | テスト | - |
| Phase 8-2 | 統合テスト | - |
| Phase 8-3 | ドキュメント | - |
| **合計** | **全フェーズ** | **-** |

---

## 主要な課題と解決策

### 1. Hilt から Koin への移行

**課題:**
- Hilt は Android 専用で KMP では使用できない
- ViewModel の注入方法が異なる

**解決策:**
- Koin を採用（KMP 対応の DI フレームワーク）
- `koin-compose-viewmodel` を使用して ViewModel を注入
- プラットフォーム固有モジュールと共通モジュールを分離

**結果:** ✅ スムーズに移行完了

---

### 2. AndroidViewModel の共通化

**課題:**
- `AndroidViewModel` は Android 専用
- `Context` への依存を排除する必要がある

**解決策:**
- `ViewModel`（androidx.lifecycle）を使用
- `Context` 依存を `RepositoryFactory` に移動
- expect/actual パターンでプラットフォーム固有実装

**結果:** ✅ 全 ViewModel を共通化

---

### 3. 通知システムの抽象化

**課題:**
- Android: `AlarmManager`
- iOS: `UNUserNotificationCenter`
- API が全く異なる

**解決策:**
- expect/actual パターンで `NotificationManager` を定義
- プラットフォーム固有の実装を actual で提供

**結果:** ✅ 両プラットフォームで動作

---

### 4. iOS フレームワークの export 設定

**課題:**
- iOS フレームワークから依存関係にアクセスできない

**解決策:**
- export する依存関係を `api` として宣言
- フレームワーク設定で `export` を追加

**結果:** ✅ ビルド成功

---

## 成功したこと ✅

1. **段階的なアプローチ**
   - 8つのフェーズに分けて移行
   - 各フェーズで動作確認とテスト

2. **expect/actual パターンの活用**
   - プラットフォーム固有機能を抽象化
   - 通知、ファイルストレージ、設定管理で効果的に使用

3. **Compose Multiplatform の採用**
   - Android の Jetpack Compose コードをほぼそのまま共通化
   - iOS でも同じ UI コードが動作

4. **テストカバレッジの向上**
   - 共通コードのテストを追加
   - 34テストケースをすべてパス

5. **ドキュメントの整備**
   - 移行ガイド、ナレッジベース、統合テスト報告書を作成
   - 他のプロジェクトでも参考にできる形式

---

## 改善点 📝

1. **iOS Git 機能の未実装**
   - iOS での JGit 相当のライブラリが不足
   - 今後、libgit2 の Kotlin/Native バインディングなどを検討

2. **ビルド時間の最適化**
   - iOS フレームワークの初回ビルドに時間がかかる
   - Gradle の設定やキャッシュの最適化が必要

3. **E2E テストの不足**
   - ユニットテストは充実したが、E2E テストが不足
   - 今後、実機での統合テストを強化

4. **パフォーマンス測定**
   - アプリサイズ、起動時間などの詳細な測定が不足
   - 今後、パフォーマンスベンチマークを実施

---

## 学んだこと 💡

1. **KMP は production-ready**
   - Kotlin Multiplatform は十分に成熟している
   - 実用的なアプリ開発に使用可能

2. **expect/actual は強力だが慎重に**
   - プラットフォーム固有機能の抽象化に有効
   - 過度に使用するとコードが複雑化

3. **Compose Multiplatform の可能性**
   - Android の Jetpack Compose 資産を活用できる
   - iOS、Desktop、Web への展開も視野に

4. **段階的移行の重要性**
   - 一度にすべてを変更せず、段階的に進めることが成功の鍵
   - 各フェーズでテストと動作確認を徹底

5. **ドキュメントの価値**
   - 移行の過程を記録することで、今後の参考になる
   - ナレッジ共有は開発チームの成長に不可欠

---

## 次のステップ

### 短期（1-3ヶ月）
- [ ] iOS Git 機能の実装
- [ ] iOS ウィジェットの追加
- [ ] E2E テストの強化
- [ ] パフォーマンスの測定と最適化

### 中期（3-6ヶ月）
- [ ] Desktop（macOS/Windows）への展開
- [ ] Web への展開（Compose for Web）
- [ ] バックグラウンド同期の実装
- [ ] 多言語対応

### 長期（6ヶ月以上）
- [ ] 他の機能の追加（画像、タグなど）
- [ ] ユーザーフィードバックの収集と改善
- [ ] パフォーマンスの継続的な改善

---

## 推奨事項

KMP/CMP 移行を検討している他のプロジェクトへの推奨事項:

1. **段階的に進める**
   - 一度にすべてを移行しようとしない
   - フェーズを分けて、各フェーズでテストを実施

2. **expect/actual を慎重に使用**
   - 本当にプラットフォーム固有の API のみに使用
   - 共通コードで解決できる場合は共通コードで

3. **Koin を検討**
   - KMP 対応の DI フレームワークとして優秀
   - Hilt より軽量でシンプル

4. **Compose Multiplatform の採用**
   - Android の Jetpack Compose 資産を活用できる
   - iOS でも同じ UI コードが動作

5. **テストを書く**
   - 共通コードには必ずテストを書く
   - 回帰を防ぎ、品質を保つ

6. **ドキュメントを整備**
   - 移行の過程を記録
   - 遭遇した問題と解決策をドキュメント化

---

## 結論

OneLine アプリの KMP/CMP 移行は成功し、Android と iOS の両プラットフォームで動作するアプリになりました。移行の過程で多くの技術的な課題に直面しましたが、段階的なアプローチとドキュメントの整備により、スムーズに移行を完了することができました。

この経験が、他のプロジェクトの KMP/CMP 移行の参考になれば幸いです。

---

**最終更新日:** 2025-11-11
**著者:** OneLine 開発チーム

**関連ドキュメント:**
- [KMP 移行ガイド](./KMP_MIGRATION_GUIDE.md)
- [ナレッジベース](./KMP_KNOWLEDGE_BASE.md)
- [統合テスト報告書](./INTEGRATION_TEST_REPORT.md)
