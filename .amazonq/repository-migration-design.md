# リポジトリ移行機能の設計

## 問題の定義

ユーザーが複数の日記リポジトリを持っている場合、以下のようなユースケースが発生する：

1. **Aリポジトリで日記を開始** → 数日間日記を記述
2. **Bリポジトリに変更したい** → 既存の日記データをどうするか？

現在の実装では、リポジトリ変更時に既存のローカルデータが削除されてしまう。

## 解決策の設計

### 1. 移行オプション

#### A. データ移行（MIGRATE_DATA）- 推奨
```
[Aリポジトリの日記] → [Bリポジトリにコピー]
```
- 既存の日記データを新しいリポジトリにプッシュ
- データの損失なし
- 新しいリポジトリで継続して日記を記述可能

#### B. バックアップして切り替え（BACKUP_AND_SWITCH）
```
[Aリポジトリの日記] → [ローカルバックアップ] + [Bリポジトリに切り替え]
```
- 既存データをローカルにバックアップ
- 新しいリポジトリは空の状態から開始
- 必要に応じて手動でデータを復元可能

#### C. データ破棄して切り替え（DISCARD_AND_SWITCH）
```
[Aリポジトリの日記] → [削除] + [Bリポジトリに切り替え]
```
- 既存データを完全に削除
- 新しいリポジトリで新規開始
- データ損失のリスクあり

### 2. UI/UXフロー

```
1. 設定画面でリポジトリURL変更
   ↓
2. 既存データの有無をチェック
   ↓
3a. データなし → 直接切り替え
3b. データあり → 移行オプション選択ダイアログ表示
   ↓
4. ユーザーが移行方法を選択
   ↓
5. 選択された方法で移行実行
   ↓
6. 完了通知
```

### 3. 技術実装

#### A. データ検出
```kotlin
private fun getLocalDiaryFiles(): List<DiaryFile> {
    return repoDirectory!!.listFiles()
        ?.filter { it.name.matches(Regex("\\d{4}-\\d{2}-\\d{2}\\.md")) }
        ?.map { DiaryFile(it.name, it.readText(), it.lastModified()) }
        ?: emptyList()
}
```

#### B. データ移行
```kotlin
suspend fun migrateDataToNewRepository(
    newRemoteUrl: String,
    localFiles: List<DiaryFile>
): Result<Boolean> {
    // 1. 新しいリポジトリを初期化
    // 2. ローカルファイルを新しいリポジトリに追加
    // 3. 移行コミット作成
    // 4. プッシュ実行
}
```

#### C. バックアップ
```kotlin
private suspend fun backupCurrentDataAndSwitch(
    localFiles: List<DiaryFile>
): Result<Boolean> {
    // 1. バックアップディレクトリ作成
    // 2. ファイルをバックアップディレクトリにコピー
    // 3. 新しいリポジトリに切り替え
}
```

### 4. エラーハンドリング

#### A. 移行失敗時の対応
- 元のリポジトリ設定を復元
- エラーメッセージを表示
- ローカルデータは保持

#### B. 部分的な移行失敗
- 成功したファイルと失敗したファイルを区別
- 失敗したファイルのリストを表示
- 再試行オプションを提供

### 5. 安全性の考慮

#### A. データ保護
- 移行前に必ずローカルバックアップを作成
- 移行失敗時のロールバック機能
- 重要な操作前の確認ダイアログ

#### B. 競合解決
- 新しいリポジトリに同名ファイルが存在する場合の処理
- タイムスタンプベースの競合解決
- ユーザーによる手動選択オプション

## 実装優先度

### Phase 1 (必須)
- [x] 基本的な移行オプションの実装
- [x] 移行選択ダイアログの実装
- [ ] データ移行機能の実装

### Phase 2 (重要)
- [ ] バックアップ機能の実装
- [ ] エラーハンドリングの強化
- [ ] 移行進捗表示

### Phase 3 (改善)
- [ ] 競合解決機能
- [ ] 移行履歴の管理
- [ ] 自動バックアップ機能

## ユーザーへの推奨事項

1. **データ移行を推奨**: 既存の日記データを失わない
2. **事前バックアップ**: 重要なデータは事前にバックアップ
3. **段階的移行**: 一度に大量のデータを移行せず、段階的に実行
4. **検証**: 移行後にデータが正しく移行されたことを確認

## 将来の拡張可能性

1. **複数リポジトリ管理**: 複数のリポジトリを同時に管理
2. **選択的移行**: 特定の日付範囲のみを移行
3. **自動同期**: 複数リポジトリ間での自動同期
4. **クラウドバックアップ**: Google Drive等への自動バックアップ
